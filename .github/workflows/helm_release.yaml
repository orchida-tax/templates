name: helm_release

on:
  workflow_call:
    inputs:
      helm_repo: { type: string, required: true }
      helm_values_file_path: { type: string, required: true }
      image_tag_path: { type: string, required: true }
      new_image_tag: { type: string, required: true }
    secrets:
      gh_pat: { required: true }

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "please validate image tag is exist in ghcr.io"
  promote:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.helm_repo }}
          ref: main
          path: helm-deployments
          token: ${{ secrets.gh_pat }}

      - name: Bump tag safely
        uses: orchida-tax/templates/.github/actions/helm_update_image_tag@main
        with:
          helm_values_file_path: helm-deployments/${{ inputs.helm_values_file_path }}
          image_tag_path: ${{ inputs.image_tag_path }}
          new_image_tag: ${{ inputs.new_image_tag }}

      - name: Push direct
        run: |
          cd helm-deployments
          git config user.name "ci-bot"
          git config user.email "ci-bot@org.com"
          git add ${{ inputs.helm_values_file_path }}
          git commit -m "Promote: ${{ inputs.new_image_tag }}" || true
          git push origin main
