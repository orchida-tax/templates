name: Build and Push Dashboard Frontend

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build-and-push-local-server:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: nabilmokhtar0/peppol-ae

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build React app inside Alpine container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            node:18-alpine sh -c "
              apk add --no-cache libc6-compat && \
              npm install --no-audit --no-fund && \
              npm install @rollup/rollup-linux-x64-musl && \
              npm run build
            "

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME:dashboard-front .

      - name: Push Docker image
        run: docker push $IMAGE_NAME:dashboard-front
